---
id: AILOG-2026-02-05-004
title: Implement onboarding wizard and Rust app scaffold (Stage 4)
status: accepted
created: 2026-02-05
agent: claude-code-v1.0
confidence: high
review_required: false
risk_level: low
tags: [onboarding, gtk4-rs, libadwaita, dbus, zbus, scaffold]
related: [AILOG-2026-02-05-001]
---

# AILOG: Implement onboarding wizard and Rust app scaffold (Stage 4)

## Summary

Created the full Rust application scaffold for the LNXDrive preferences/onboarding
application using gtk4-rs 0.9 + libadwaita-rs 0.7. Implemented a three-step
onboarding wizard (OAuth2 auth, folder selection, confirmation), a D-Bus client
wrapping all daemon interfaces via zbus 5 `#[proxy]` macros, and a stub
preferences dialog.

## Context

Stage 4 of the 001-gnome-integration spec requires a GTK4/libadwaita Rust
application that provides a first-run onboarding wizard (OAuth2 authentication,
folder selection, start sync) and will later host the preferences panel.
The existing `preferences/Cargo.toml` and `preferences/meson.build` were
already configured. This task created all source files under `preferences/src/`.

## Actions Performed

1. Created `main.rs` -- entry point with gettext i18n initialization and `LnxdriveApp` launch
2. Created `app.rs` -- `adw::Application` subclass that checks D-Bus auth state on activate
3. Created `window.rs` -- `adw::ApplicationWindow` subclass with GSettings geometry persistence
4. Created `dbus_client.rs` -- full async D-Bus client with 4 proxy traits (Auth, Settings, Status, Sync) and `DbusClient` wrapper struct
5. Created `onboarding/mod.rs` -- `adw::NavigationView` subclass with shared `OnboardingState`
6. Created `onboarding/auth_page.rs` -- Sign-in page with browser launch, spinner, and `AuthStateChanged` signal subscription
7. Created `onboarding/folder_page.rs` -- Folder chooser page with `gtk4::FileDialog`
8. Created `onboarding/confirm_page.rs` -- Summary/confirmation page with "Start Syncing"
9. Created `preferences/mod.rs` -- Stub preferences dialog using `adw::PreferencesWindow`
10. Added `futures-util = "0.3"` dependency to Cargo.toml for signal stream iteration

## Modified Files

| File | Change |
|------|--------|
| `preferences/Cargo.toml` | Added `futures-util = "0.3"` dependency |
| `preferences/src/main.rs` | New: entry point with gettext init |
| `preferences/src/app.rs` | New: adw::Application subclass |
| `preferences/src/window.rs` | New: adw::ApplicationWindow subclass |
| `preferences/src/dbus_client.rs` | New: D-Bus client with 4 proxy interfaces |
| `preferences/src/onboarding/mod.rs` | New: NavigationView subclass, OnboardingState |
| `preferences/src/onboarding/auth_page.rs` | New: OAuth2 auth page |
| `preferences/src/onboarding/folder_page.rs` | New: folder selection page |
| `preferences/src/onboarding/confirm_page.rs` | New: confirmation page |
| `preferences/src/preferences/mod.rs` | New: stub preferences dialog |

## Decisions Made

- Used zbus `#[proxy]` macro for D-Bus client rather than manual proxy calls, for type safety and signal subscription support
- Used `glib::MainContext::default().spawn_local()` for all async D-Bus operations instead of tokio, to stay on the GTK main loop
- Used `adw::NavigationView` for the onboarding wizard navigation (push/pop pattern)
- Cloned the D-Bus `Connection` when creating signal proxies to avoid lifetime issues with concurrent method calls
- Used `glib::ExitCode` as the return type of `main()` directly rather than converting to `std::process::ExitCode`

## Impact

- **Functionality**: Provides the full onboarding flow UI and D-Bus client layer; requires the mock D-Bus daemon (Stage 1) for testing
- **Performance**: N/A -- standard GTK application
- **Security**: OAuth2 auth uses system browser + loopback redirect (RFC 8252), no embedded WebView

## Verification

- [ ] Code compiles without errors (Bash tool was unavailable for cargo check)
- [ ] Tests pass (no unit tests added in this stage)
- [ ] Manual review performed

## Additional Notes

- The `LnxdriveAuthProxy` type generated by the zbus `#[proxy]` macro is exposed publicly so the auth page can create its own proxy for signal subscriptions
- The preferences module is a minimal stub; it will be expanded in a later stage
- The `lnxdrive-ipc` crate dependency is commented out in Cargo.toml as it is not yet available; all D-Bus communication goes through the direct zbus proxy layer
- Compilation could not be verified during this session due to Bash tool access restrictions; the user should run `cargo check` in `preferences/` to verify

---

<!-- Template: DevTrail | https://enigmora.com -->
